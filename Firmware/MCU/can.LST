C166 COMPILER V7.53.0.0, CAN                                                               07/18/2016 17:40:38 PAGE 1   


C166 COMPILER V7.53.0.0, COMPILATION OF MODULE CAN
OBJECT MODULE PLACED IN can.OBJ
COMPILER INVOKED BY: C:\Keil\C166\BIN\C166.EXE can.c BROWSE MOD167 DEBUG TABS(2) 

 stmt lvl     source

    1         #include "can.h"
    2         #include "settings.h"
    3         
    4         
    5         void CAN_Interrupt0() interrupt 0x54  //722 Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ(Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð°)
    6         {
    7  1        
    8  1      }
    9         
   10         void CAN_Interrupt1() interrupt 0x55  //222 Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ(Ð¿Ñ€Ð¸ÐµÐ¼)
   11         {
   12  1        uint8 command   = (uint8)(CAN_Message_16[3].MODATALL & 0x00FF);
   13  1        uint8 index     = (uint8)((CAN_Message_16[3].MODATALL >> 8) & 0x00FF);
   14  1        uint8 subindex  = (uint8)((CAN_Message_16[3].MODATALH >> 8) & 0x00FF);
   15  1          
   16  1        
   17  1        
   18  1        uint16  *pFactor = 0;
   19  1        uint16  hexValueL = 0;
   20  1        uint16  hexValueH = 0;
   21  1        uint8   canData[8];
   22  1        
   23  1        switch(command)
   24  1        {
   25  2          case 0x04:  //Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°
   26  2          {
   27  3            switch(index)
   28  3            {
   29  4              case 0x93: //Ð¿Ð¾Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾ÑÑ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚
   30  4              {
   31  5                hexValueL = (CAN_Message_16[3].MODATAHL);
   32  5                hexValueH = (CAN_Message_16[3].MODATAHH);
   33  5                
   34  5                pFactor =  (uint16*)&MainSettings.fFactor[subindex];
   35  5                
   36  5                *(pFactor) = hexValueL;
   37  5                *(pFactor + 1) = hexValueH;
   38  5                
   39  5                canData[0] = command;
   40  5                canData[1] = index;
   41  5                canData[2] = 0x00;
   42  5                canData[3] = subindex;
   43  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   44  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   45  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   46  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   47  5                
   48  5                CAN_LoadData(0,canData);
   49  5                CAN_SendMessage(0);
   50  5                
   51  5              }break;
   52  4              
   53  4              case 0xE0:  //Ð·Ð°Ð¿Ð¸ÑÑŒ Ð²Ð¾ FLASH
   54  4              {
   55  5                hexValueL = (CAN_Message_16[3].MODATAHL);
C166 COMPILER V7.53.0.0, CAN                                                               07/18/2016 17:40:38 PAGE 2   

   56  5                hexValueH = (CAN_Message_16[3].MODATAHH);
   57  5                
   58  5                if(subindex == 0x00){
   59  6                  SETTINGS_Default();
   60  6                }
   61  5                if(subindex == 0xFF){
   62  6                  SETTINGS_Save();
   63  6                }
   64  5                
   65  5                canData[0] = command;
   66  5                canData[1] = index;
   67  5                canData[2] = 0x00;
   68  5                canData[3] = subindex;
   69  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   70  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   71  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   72  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   73  5                
   74  5                CAN_LoadData(0,canData);
   75  5                CAN_SendMessage(0);
   76  5              }break;
   77  4            }
   78  3          }break;
   79  2          
   80  2          case 0x05:  //Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°
   81  2          {
   82  3            switch(index)
   83  3            {
   84  4              case 0x93:  //Ð¿Ð¾Ð¿Ñ€Ð°Ð²Ð¾Ñ‡Ð½Ñ‹Ð¹ ÐºÐ¾ÑÑ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚
   85  4              {
   86  5                pFactor =  (uint16*)&MainSettings.fFactor[subindex];
   87  5                hexValueL = *(pFactor);
   88  5                hexValueH = *(pFactor + 1);
   89  5      
   90  5                canData[0] = command;
   91  5                canData[1] = index;
   92  5                canData[2] = 0x00;
   93  5                canData[3] = subindex;
   94  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   95  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   96  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   97  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   98  5                
   99  5                CAN_LoadData(0,canData);
  100  5                CAN_SendMessage(0);
  101  5                
  102  5              }break;
  103  4            }
  104  3          }break;
  105  2        }
  106  1        
  107  1      
  108  1      }
  109         
  110         void CAN_Interrupt2() interrupt 0x56  //180 Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ(Ð¿Ñ€Ð¸ÐµÐ¼)
  111         {
  112  1        
  113  1      }
  114         
  115         
  116         void CAN_Init()
  117         {
C166 COMPILER V7.53.0.0, CAN                                                               07/18/2016 17:40:38 PAGE 3   

  118  1        DP4 &= 0x00CF;          // P4.4 P4.5 Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° Ð²Ð²Ð¾Ð´(Ð²Ñ…Ð¾Ð´ CAN ÑƒÐ·Ð»Ð° 0 Ð¸ ÑƒÐ·Ð»Ð° 
             -1)
  119  1        ALTSEL0P4 &= 0x00DF;          // Ð’Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ P4.5(Ð´Ð»Ñ
             - P4.4 Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÐ¼)
  120  1        DP4 |= 0x00C0;          // P4.6 P4.7 Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ñƒ(Ð’Ñ‹Ñ…Ð¾Ð´ CAN ÑƒÐ·Ð»Ð° 0 Ð
             -¸ ÑƒÐ·Ð»Ð° 1)
  121  1        ALTSEL0P4 |= 0x00C0;          // Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ P4.6 Ð¸ P4.7
  122  1      
  123  1        CAN_IC0 = 0x005C; //722
  124  1        CAN_IC1 = 0x0060; //222
  125  1        CAN_IC2 = 0x0074; //180
  126  1        
  127  1        NCR0  = 0x0041;   //Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ Ð²Ð½Ð¾ÑÐ¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ
  128  1        NPCR0 = 0x0000;   //Ð’Ñ‹Ð±Ñ€Ð°Ð»Ð¸ P4.5 Ð´Ð»Ñ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð² CAN ÑƒÐ·ÐµÐ» 0
  129  1        NBTR0 = 0x2341;   //ÑÐºÐ¾Ñ€Ð¾ÑÑ‚ÑŒ ÑƒÐ·Ð»Ð° 500kb/sec Ð¿Ñ€Ð¸ Ñ‚Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ 16ÐœÐ³Ñ†
  130  1        NCR0  = 0x0000;   //Ð—Ð°Ð¿Ñ€ÐµÑ‚ Ð¿Ð¾ÑÐ»Ðµ Ñ€ÐµÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸
  131  1        
  132  1        /*
  133  1          Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¾Ð±Ð»Ð°ÑÑ‚ÐµÐ¹ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
  134  1        
  135  1          ÐÐ° Ð¿Ñ€Ð¸Ñ‘Ð¼
  136  1            1. 222 - Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹(Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ)
  137  1            2. 180 - Ð¿Ñ€Ð¸ÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‚/ÑÑ‚Ð¾Ð¿ Ð‘Ð”Ð“ÐŸ(Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ)
  138  1          ÐÐ° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ñƒ
  139  1            1. 422 - Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹
  140  1            2. 722 - Ð´Ð°Ð½Ð½Ñ‹Ðµ (Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ)
  141  1            3. 280 - Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð° ÑÑ‚Ð°Ñ€Ñ‚/ÑÑ‚Ð¾Ð¿
  142  1        */
  143  1        //422
  144  1        CAN_Message_16[0].MOCTRH = 0x0E08;
  145  1        CAN_Message_16[0].MOCTRL = 0x0000;
  146  1        CAN_Message_16[0].MOIPRL = 0x0000;  /*Ð²Ñ‹Ð±Ð¾Ñ€ Ð»Ð¸Ð½Ð¸Ð¸ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ -
             - 0*/
  147  1        CAN_Message_16[0].MOFCRH = 0x0800; // DLC = 8, Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°
             -Ñ‡Ñƒ 
  148  1        
  149  1        //722
  150  1        CAN_Message_16[1].MOCTRH = 0x0E08;
  151  1        CAN_Message_16[1].MOCTRL = 0x0000;
  152  1        CAN_Message_16[1].MOIPRL = 0x0000;  // Ð²Ñ‹Ð±Ð¾Ñ€ Ð»Ð¸Ð½Ð¸Ð¸ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸
             - - 0
  153  1        CAN_Message_16[1].MOFCRH = 0x0802;  // Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ñƒ
  154  1        
  155  1        //280
  156  1        CAN_Message_16[2].MOCTRH = 0x0E08;
  157  1        CAN_Message_16[2].MOCTRL = 0x0000;
  158  1        CAN_Message_16[2].MOIPRL = 0x0000;  /*Ð²Ñ‹Ð±Ð¾Ñ€ Ð»Ð¸Ð½Ð¸Ð¸ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ´Ð°Ñ‡Ð¸ -
             - 0*/
  159  1        CAN_Message_16[2].MOFCRH = 0x0800; // DLC = 8, Ð·Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð½Ð° Ð¿ÐµÑ€ÐµÐ´Ð°
             -Ñ‡Ñƒ 
  160  1        
  161  1        //222
  162  1        CAN_Message_16[3].MOCTRH = 0x0080;
  163  1        CAN_Message_16[3].MOCTRL = 0x0000;
  164  1        CAN_Message_16[3].MOIPRL = 0x0001;  //Ð²Ñ‹Ð±Ð¾Ñ€ Ð»Ð¸Ð½Ð¸Ð¸ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ñƒ - 1
  165  1        CAN_Message_16[3].MOFCRH = 0x0801;  //Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¿Ñ€Ð¸ÐµÐ¼
  166  1        
  167  1        //180
  168  1        CAN_Message_16[4].MOCTRH = 0x0080;
  169  1        CAN_Message_16[4].MOCTRL = 0x0000;
  170  1        CAN_Message_16[4].MOIPRL = 0x0002;  // Ð²Ñ‹Ð±Ð¾Ñ€ Ð»Ð¸Ð½Ð¸Ð¸ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°Ð½Ð¸Ð¹ Ð¿Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ñƒ - 2
  171  1        CAN_Message_16[4].MOFCRH = 0x0801;  //Ñ€Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑ€Ñ‹Ð²Ð°ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¿Ñ€Ð¸ÐµÐ¼
C166 COMPILER V7.53.0.0, CAN                                                               07/18/2016 17:40:38 PAGE 4   

  172  1      
  173  1        delay(10);
  174  1        
  175  1        CAN_Message_16[0].MOARH = 0x9088;  // Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ 422h
  176  1        CAN_Message_16[0].MOAMRH = 0x3FFF; // Ð¼Ð°ÑÐºÐ° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° 
  177  1          
  178  1        CAN_Message_16[1].MOARH = 0x9C88;  // Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ 722h
  179  1        CAN_Message_16[1].MOAMRH = 0x3FFF; // Ð¼Ð°ÑÐºÐ° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð°   
  180  1        
  181  1        CAN_Message_16[2].MOARH = 0x8A00;  // Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ 280h
  182  1        CAN_Message_16[2].MOAMRH = 0x3FFF; // Ð¼Ð°ÑÐºÐ° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð°   
  183  1        
  184  1        CAN_Message_16[3].MOARH = 0x8888;  // Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ 222h
  185  1        CAN_Message_16[3].MOAMRH = 0x3FFF; // Ð¼Ð°ÑÐºÐ° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° 
  186  1        
  187  1        CAN_Message_16[4].MOARH = 0x8600;  // Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ 180h
  188  1        CAN_Message_16[4].MOAMRH = 0x3FFF; // Ð¼Ð°ÑÐºÐ° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€Ð° 
  189  1      
  190  1        delay(10);
  191  1        
  192  1        PANCTR_H = 0x0100;         // message object 0 -> List 1
  193  1        PANCTR = 0x0002;           
  194  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();
  195  1         
  196  1        PANCTR_H = 0x0101;         // message object 1 -> List 1
  197  1        PANCTR = 0x0002;             
  198  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); 
  199  1         
  200  1         
  201  1        PANCTR_H = 0x0102;         // message object 2 -> List 1
  202  1        PANCTR = 0x0002;             
  203  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  204  1         
  205  1        PANCTR_H = 0x0103;         // message object 3 -> List 1
  206  1        PANCTR = 0x0002;             
  207  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  208  1      
  209  1      
  210  1        PANCTR_H = 0x0104;         // message object 4 -> List 1
  211  1        PANCTR = 0x0002;             
  212  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  213  1      
  214  1      
  215  1        CAN_Message_16[0].MOCTRH = 0x0020; 
  216  1        CAN_Message_16[0].MOCTRL = 0x0000;
  217  1        
  218  1        CAN_Message_16[1].MOCTRH = 0x0020; 
  219  1        CAN_Message_16[1].MOCTRL = 0x0000;
  220  1        
  221  1        CAN_Message_16[2].MOCTRH = 0x0020; 
  222  1        CAN_Message_16[2].MOCTRL = 0x0000;
  223  1        
  224  1        CAN_Message_16[3].MOCTRH = 0x0020; 
  225  1        CAN_Message_16[3].MOCTRL = 0x0000;
  226  1        
  227  1        CAN_Message_16[4].MOCTRH = 0x0020; 
  228  1        CAN_Message_16[4].MOCTRL = 0x0000;  
  229  1        
  230  1      }
  231         void CAN_SendMessage(uint8 moNubmer)
  232         { 
  233  1      
C166 COMPILER V7.53.0.0, CAN                                                               07/18/2016 17:40:38 PAGE 5   

  234  1        CAN_Message_16[moNubmer].MOCTRH = 0x0100; 
  235  1      }
  236         void CAN_LoadData(uint8 moNubmer,uint8 *canData)
  237         {
  238  1        CAN_Message_16[moNubmer].MODATALL = (canData[1] << 8) | canData[0];
  239  1        CAN_Message_16[moNubmer].MODATALH = (canData[3] << 8) | canData[2];
  240  1        CAN_Message_16[moNubmer].MODATAHL = (canData[5] << 8) | canData[4];
  241  1        CAN_Message_16[moNubmer].MODATAHH = (canData[7] << 8) | canData[6];
  242  1      }
  243         
  244         


MODULE INFORMATION:   INITIALIZED  UNINITIALIZED
  CODE SIZE        =        1176     --------
  NEAR-CONST SIZE  =    --------     --------
  FAR-CONST SIZE   =    --------     --------
  HUGE-CONST SIZE  =    --------     --------
  XHUGE-CONST SIZE =    --------     --------
  NEAR-DATA SIZE   =    --------     --------
  FAR-DATA SIZE    =    --------     --------
  XHUGE-DATA SIZE  =    --------     --------
  IDATA-DATA SIZE  =    --------     --------
  SDATA-DATA SIZE  =    --------     --------
  BDATA-DATA SIZE  =    --------     --------
  HUGE-DATA SIZE   =    --------     --------
  BIT SIZE         =    --------     --------
  INIT'L SIZE      =    --------     --------
END OF MODULE INFORMATION.


C166 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
