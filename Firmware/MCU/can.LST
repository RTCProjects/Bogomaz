C166 COMPILER V7.53.0.0, CAN                                                               07/19/2016 10:56:35 PAGE 1   


C166 COMPILER V7.53.0.0, COMPILATION OF MODULE CAN
OBJECT MODULE PLACED IN can.OBJ
COMPILER INVOKED BY: C:\Keil\C166\BIN\C166.EXE can.c BROWSE MOD167 DEBUG TABS(2) 

 stmt lvl     source

    1         #include "can.h"
    2         #include "settings.h"
    3         
    4         
    5         void CAN_Interrupt0() interrupt 0x54  //722 –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ(–ø–µ—Ä–µ–¥–∞—á–∞)
    6         {
    7  1        
    8  1      }
    9         
   10         void CAN_Interrupt1() interrupt 0x55  //222 –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ(–ø—Ä–∏–µ–º)
   11         {
   12  1        uint8 command   = (uint8)(CAN_Message_16[3].MODATALL & 0x00FF);
   13  1        uint8 index     = (uint8)((CAN_Message_16[3].MODATALL >> 8) & 0x00FF);
   14  1        uint8 subindex  = (uint8)((CAN_Message_16[3].MODATALH >> 8) & 0x00FF);
   15  1          
   16  1        
   17  1        
   18  1        uint16  *pFactor = 0;
   19  1        uint16  hexValueL = 0;
   20  1        uint16  hexValueH = 0;
   21  1        uint8   canData[8];
   22  1        
   23  1        switch(command)
   24  1        {
   25  2          case 0x04:  //–∑–∞–¥–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
   26  2          {
   27  3            switch(index)
   28  3            {
   29  4              case 0x93: //–ø–æ–ø—Ä–∞–≤–æ—á–Ω—ã–π –∫–æ—ç—Ñ–∏—Ü–∏–µ–Ω—Ç
   30  4              {
   31  5                hexValueL = (CAN_Message_16[3].MODATAHL);
   32  5                hexValueH = (CAN_Message_16[3].MODATAHH);
   33  5                
   34  5                pFactor =  (uint16*)&MainSettings.fFactor[subindex];
   35  5                
   36  5                *(pFactor) = hexValueL;
   37  5                *(pFactor + 1) = hexValueH;
   38  5                
   39  5                canData[0] = command;
   40  5                canData[1] = index;
   41  5                canData[2] = 0x00;
   42  5                canData[3] = subindex;
   43  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   44  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   45  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   46  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   47  5                
   48  5                CAN_LoadData(0,canData);
   49  5                CAN_SendMessage(0);
   50  5                
   51  5              }break;
   52  4              
   53  4              case 0xE0:  //–∑–∞–ø–∏—Å—å –≤–æ FLASH
   54  4              {
   55  5                hexValueL = (CAN_Message_16[3].MODATAHL);
C166 COMPILER V7.53.0.0, CAN                                                               07/19/2016 10:56:35 PAGE 2   

   56  5                hexValueH = (CAN_Message_16[3].MODATAHH);
   57  5                
   58  5                if(subindex == 0x00){
   59  6                  SETTINGS_Default();
   60  6                  SETTINGS_Save();
   61  6                }
   62  5                if(subindex == 0xFF){
   63  6                  SETTINGS_Save();
   64  6                }
   65  5                
   66  5                canData[0] = command;
   67  5                canData[1] = index;
   68  5                canData[2] = 0x00;
   69  5                canData[3] = subindex;
   70  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   71  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   72  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   73  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   74  5                
   75  5                CAN_LoadData(0,canData);
   76  5                CAN_SendMessage(0);
   77  5              }break;
   78  4            }
   79  3          }break;
   80  2          
   81  2          case 0x05:  //–ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞
   82  2          {
   83  3            switch(index)
   84  3            {
   85  4              case 0x93:  //–ø–æ–ø—Ä–∞–≤–æ—á–Ω—ã–π –∫–æ—ç—Ñ–∏—Ü–∏–µ–Ω—Ç
   86  4              {
   87  5                pFactor =  (uint16*)&MainSettings.fFactor[subindex];
   88  5                hexValueL = *(pFactor);
   89  5                hexValueH = *(pFactor + 1);
   90  5      
   91  5                canData[0] = command;
   92  5                canData[1] = index;
   93  5                canData[2] = 0x00;
   94  5                canData[3] = subindex;
   95  5                canData[4] =  (uint8)(hexValueL & 0x00FF);
   96  5                canData[5] =  (uint8)((hexValueL >> 8) & 0x00FF);
   97  5                canData[6] =  (uint8)(hexValueH & 0x00FF);
   98  5                canData[7] =  (uint8)((hexValueH >> 8) & 0x00FF);
   99  5                
  100  5                CAN_LoadData(0,canData);
  101  5                CAN_SendMessage(0);
  102  5                
  103  5              }break;
  104  4            }
  105  3          }break;
  106  2        }
  107  1        
  108  1      
  109  1      }
  110         
  111         void CAN_Interrupt2() interrupt 0x56  //180 –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ(–ø—Ä–∏–µ–º)
  112         {
  113  1        
  114  1      }
  115         
  116         
  117         void CAN_Init()
C166 COMPILER V7.53.0.0, CAN                                                               07/19/2016 10:56:35 PAGE 3   

  118         {
  119  1        DP4 &= 0x00CF;          // P4.4 P4.5 –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞ –≤–≤–æ–¥(–≤—Ö–æ–¥ CAN —É–∑–ª–∞ 0 –∏ —É–∑–ª–∞ 
             -1)
  120  1        ALTSEL0P4 &= 0x00DF;          // –í—ã–∫–ª—é—á–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é P4.5(–¥–ª—è
             - P4.4 –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º)
  121  1        DP4 |= 0x00C0;          // P4.6 P4.7 –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É(–í—ã—Ö–æ–¥ CAN —É–∑–ª–∞ 0 –
             -∏ —É–∑–ª–∞ 1)
  122  1        ALTSEL0P4 |= 0x00C0;          // –í–∫–ª—é—á–∏—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ P4.6 –∏ P4.7
  123  1      
  124  1        CAN_IC0 = 0x005C; //722
  125  1        CAN_IC1 = 0x0060; //222
  126  1        CAN_IC2 = 0x0074; //180
  127  1        
  128  1        NCR0  = 0x0041;   //—Ä–∞–∑—Ä–µ—à–∞–µ–º –≤–Ω–æ—Å–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
  129  1        NPCR0 = 0x0000;   //–í—ã–±—Ä–∞–ª–∏ P4.5 –¥–ª—è –ø—Ä–∏–µ–º–∞ –≤ CAN —É–∑–µ–ª 0
  130  1        NBTR0 = 0x2341;   //—Å–∫–æ—Ä–æ—Å—Ç—å —É–∑–ª–∞ 500kb/sec –ø—Ä–∏ —Ç–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ 16–ú–≥—Ü
  131  1        NCR0  = 0x0000;   //–ó–∞–ø—Ä–µ—Ç –ø–æ—Å–ª–µ —Ä–µ–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
  132  1        
  133  1        /*
  134  1          –°–ø–∏—Å–æ–∫ –æ–±–ª–∞—Å—Ç–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π
  135  1        
  136  1          –ù–∞ –ø—Ä–∏—ë–º
  137  1            1. 222 - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã(–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)
  138  1            2. 180 - –ø—Ä–∏–µ–º —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø –ë–î–ì–ü(–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)
  139  1          –ù–∞ –ø–µ—Ä–µ–¥–∞—á—É
  140  1            1. 422 - –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
  141  1            2. 722 - –¥–∞–Ω–Ω—ã–µ (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)
  142  1            3. 280 - –ø–µ—Ä–µ–¥–∞—á–∞ —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø
  143  1        */
  144  1        //422
  145  1        CAN_Message_16[0].MOCTRH = 0x0E08;
  146  1        CAN_Message_16[0].MOCTRL = 0x0000;
  147  1        CAN_Message_16[0].MOIPRL = 0x0000;  /*–≤—ã–±–æ—Ä –ª–∏–Ω–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ -
             - 0*/
  148  1        CAN_Message_16[0].MOFCRH = 0x0800; // DLC = 8, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–¥–∞
             -—á—É 
  149  1        
  150  1        //722
  151  1        CAN_Message_16[1].MOCTRH = 0x0E08;
  152  1        CAN_Message_16[1].MOCTRL = 0x0000;
  153  1        CAN_Message_16[1].MOIPRL = 0x0000;  // –≤—ã–±–æ—Ä –ª–∏–Ω–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏
             - - 0
  154  1        CAN_Message_16[1].MOFCRH = 0x0802;  // —Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–¥–∞—á—É
  155  1        
  156  1        //280
  157  1        CAN_Message_16[2].MOCTRH = 0x0E08;
  158  1        CAN_Message_16[2].MOCTRL = 0x0000;
  159  1        CAN_Message_16[2].MOIPRL = 0x0000;  /*–≤—ã–±–æ—Ä –ª–∏–Ω–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ -
             - 0*/
  160  1        CAN_Message_16[2].MOFCRH = 0x0800; // DLC = 8, –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–¥–∞
             -—á—É 
  161  1        
  162  1        //222
  163  1        CAN_Message_16[3].MOCTRH = 0x0080;
  164  1        CAN_Message_16[3].MOCTRL = 0x0000;
  165  1        CAN_Message_16[3].MOIPRL = 0x0001;  //–≤—ã–±–æ—Ä –ª–∏–Ω–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –ø–æ –ø—Ä–∏–µ–º—É - 1
  166  1        CAN_Message_16[3].MOFCRH = 0x0801;  //—Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∏–µ–º
  167  1        
  168  1        //180
  169  1        CAN_Message_16[4].MOCTRH = 0x0080;
  170  1        CAN_Message_16[4].MOCTRL = 0x0000;
  171  1        CAN_Message_16[4].MOIPRL = 0x0002;  // –≤—ã–±–æ—Ä –ª–∏–Ω–∏–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–π –ø–æ –ø—Ä–∏–µ–º—É - 2
C166 COMPILER V7.53.0.0, CAN                                                               07/19/2016 10:56:35 PAGE 4   

  172  1        CAN_Message_16[4].MOFCRH = 0x0801;  //—Ä–∞–∑—Ä–µ—à–∏—Ç—å –ø—Ä–µ—Ä—ã–≤–∞–µ–Ω–∏–µ –Ω–∞ –ø—Ä–∏–µ–º
  173  1      
  174  1        delay(10);
  175  1        
  176  1        CAN_Message_16[0].MOARH = 0x9088;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä 422h
  177  1        CAN_Message_16[0].MOAMRH = 0x3FFF; // –º–∞—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ 
  178  1          
  179  1        CAN_Message_16[1].MOARH = 0x9C88;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä 722h
  180  1        CAN_Message_16[1].MOAMRH = 0x3FFF; // –º–∞—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞   
  181  1        
  182  1        CAN_Message_16[2].MOARH = 0x8A00;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä 280h
  183  1        CAN_Message_16[2].MOAMRH = 0x3FFF; // –º–∞—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞   
  184  1        
  185  1        CAN_Message_16[3].MOARH = 0x8888;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä 222h
  186  1        CAN_Message_16[3].MOAMRH = 0x3FFF; // –º–∞—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ 
  187  1        
  188  1        CAN_Message_16[4].MOARH = 0x8600;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä 180h
  189  1        CAN_Message_16[4].MOAMRH = 0x3FFF; // –º–∞—Å–∫–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ 
  190  1      
  191  1        delay(10);
  192  1        
  193  1        PANCTR_H = 0x0100;         // message object 0 -> List 1
  194  1        PANCTR = 0x0002;           
  195  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();
  196  1         
  197  1        PANCTR_H = 0x0101;         // message object 1 -> List 1
  198  1        PANCTR = 0x0002;             
  199  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); 
  200  1         
  201  1         
  202  1        PANCTR_H = 0x0102;         // message object 2 -> List 1
  203  1        PANCTR = 0x0002;             
  204  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  205  1         
  206  1        PANCTR_H = 0x0103;         // message object 3 -> List 1
  207  1        PANCTR = 0x0002;             
  208  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  209  1      
  210  1      
  211  1        PANCTR_H = 0x0104;         // message object 4 -> List 1
  212  1        PANCTR = 0x0002;             
  213  1         _nop_(); _nop_(); _nop_(); _nop_(); _nop_(); _nop_();   
  214  1      
  215  1      
  216  1        CAN_Message_16[0].MOCTRH = 0x0020; 
  217  1        CAN_Message_16[0].MOCTRL = 0x0000;
  218  1        
  219  1        CAN_Message_16[1].MOCTRH = 0x0020; 
  220  1        CAN_Message_16[1].MOCTRL = 0x0000;
  221  1        
  222  1        CAN_Message_16[2].MOCTRH = 0x0020; 
  223  1        CAN_Message_16[2].MOCTRL = 0x0000;
  224  1        
  225  1        CAN_Message_16[3].MOCTRH = 0x0020; 
  226  1        CAN_Message_16[3].MOCTRL = 0x0000;
  227  1        
  228  1        CAN_Message_16[4].MOCTRH = 0x0020; 
  229  1        CAN_Message_16[4].MOCTRL = 0x0000;  
  230  1        
  231  1      }
  232         void CAN_SendMessage(uint8 moNubmer)
  233         { 
C166 COMPILER V7.53.0.0, CAN                                                               07/19/2016 10:56:35 PAGE 5   

  234  1      
  235  1        CAN_Message_16[moNubmer].MOCTRH = 0x0100; 
  236  1      }
  237         void CAN_LoadData(uint8 moNubmer,uint8 *canData)
  238         {
  239  1        CAN_Message_16[moNubmer].MODATALL = (canData[1] << 8) | canData[0];
  240  1        CAN_Message_16[moNubmer].MODATALH = (canData[3] << 8) | canData[2];
  241  1        CAN_Message_16[moNubmer].MODATAHL = (canData[5] << 8) | canData[4];
  242  1        CAN_Message_16[moNubmer].MODATAHH = (canData[7] << 8) | canData[6];
  243  1      }
  244         
  245         


MODULE INFORMATION:   INITIALIZED  UNINITIALIZED
  CODE SIZE        =        1180     --------
  NEAR-CONST SIZE  =    --------     --------
  FAR-CONST SIZE   =    --------     --------
  HUGE-CONST SIZE  =    --------     --------
  XHUGE-CONST SIZE =    --------     --------
  NEAR-DATA SIZE   =    --------     --------
  FAR-DATA SIZE    =    --------     --------
  XHUGE-DATA SIZE  =    --------     --------
  IDATA-DATA SIZE  =    --------     --------
  SDATA-DATA SIZE  =    --------     --------
  BDATA-DATA SIZE  =    --------     --------
  HUGE-DATA SIZE   =    --------     --------
  BIT SIZE         =    --------     --------
  INIT'L SIZE      =    --------     --------
END OF MODULE INFORMATION.


C166 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
